import streamlit as st
from groq import Groq
import requests
from PIL import Image
from io import BytesIO
import urllib.parse

# 1. Page Setup
st.set_page_config(page_title="Genis Pro 1.2")
st.title("ðŸ¤– Genis Pro 1.2")

# 2. API Setup (Use Streamlit Secrets for safety!)
if "GROQ_API_KEY" in st.secrets:
    client = Groq(api_key=st.secrets["GROQ_API_KEY"])
else:
    st.error("Missing API Key. Please add it to Streamlit Secrets.")
    st.stop()

# 3. The "Brainwash" Step (System Prompt)
if "messages" not in st.session_state:
    st.session_state.messages = [
        {
            "role": "system", 
            "content": (
                "You are Genis Pro 1.2, a helpful AI assistant with image generation capabilities. "
                "You are NOT developed by Meta. You are NOT Llama. "
                "If asked about your identity or creators, you must reply: "
                "'I am Genis Pro 1.2, an advanced AI assistant.' "
                "Do not mention Meta, Facebook, or Llama in your responses. "
                "When users ask you to generate, create, or make an image, respond with: "
                "'GENERATE_IMAGE: [detailed description of the image]' "
                "Make the description detailed and photorealistic."
            )
        }
    ]

# 4. Function to Generate Image using Pollinations.ai
def generate_image(prompt):
    """Generate image using Pollinations.ai - completely free, no API key needed"""
    try:
        # Encode the prompt for URL
        encoded_prompt = urllib.parse.quote(prompt)
        
        # Pollinations.ai endpoint - produces high quality images
        url = f"https://image.pollinations.ai/prompt/{encoded_prompt}?width=1024&height=1024&model=flux&nologo=true"
        
        # Fetch the image
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        
        # Load image
        img = Image.open(BytesIO(response.content))
        return img
    except Exception as e:
        st.error(f"Image generation failed: {str(e)}")
        return None

# 5. Display Chat History (Hide the system message from view)
for message in st.session_state.messages:
    if message["role"] != "system":
        with st.chat_message(message["role"]):
            if message.get("image"):
                st.image(message["image"], caption="Generated by Genis Pro 1.2")
            else:
                st.markdown(message["content"])

# 6. Handle User Input
if prompt := st.chat_input("Hello! Ask me anything or request an image..."):
    # Show user message
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    # 7. Generate Response
    with st.chat_message("assistant"):
        stream = client.chat.completions.create(
            model="llama3-8b-8192",
            messages=st.session_state.messages,
            stream=True,
        )
        response = st.write_stream(stream)
    
    # 8. Check if response contains image generation request
    if response.startswith("GENERATE_IMAGE:"):
        # Extract the image prompt
        image_prompt = response.replace("GENERATE_IMAGE:", "").strip()
        
        with st.spinner("ðŸŽ¨ Generating your image..."):
            img = generate_image(image_prompt)
        
        if img:
            st.image(img, caption="Generated by Genis Pro 1.2")
            st.session_state.messages.append({
                "role": "assistant", 
                "content": f"Here's your image based on: {image_prompt}",
                "image": img
            })
        else:
            st.session_state.messages.append({
                "role": "assistant", 
                "content": "Sorry, I couldn't generate the image. Please try again."
            })
    else:
        # Save regular assistant response
        st.session_state.messages.append({"role": "assistant", "content": response})
